<html class="h-full bg-white">
    <head>
        <div th:replace="~{fragments/head}"></div>
  
    </head>
    <body class="h-full" x-data="{ isSidebarOpen: false }">
      <div>
        <div th:replace="~{fragments/sidebar}"></div>

      
        <main class="py-10 lg:pl-72">
          <div class="px-4 sm:px-6 lg:px-8">
            <div>
              <nav  aria-label="Back">
                <a th:href="@{/w/{worskpaceId}(worskpaceId=${workspace.id} )}" class="flex items-center text-sm font-medium text-gray-500 hover:text-gray-700">
                  <svg class="-ml-1 mr-1 h-5 w-5 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                  </svg>
                  <span th:text="${workspace.name}">Back</span>
                </a>
              </nav>

              <div class="mt-2 lg:flex lg:items-center lg:justify-between">
                <div class="min-w-0 flex-1">
                  <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">
                    New thread
                  </h2>
                </div>
              </div>
            </div>
            
            <form method="POST" 
                  th:action="@{/w/{workspaceId}/compose(workspaceId=${workspace.id} )}"
                  x-data="{ 
                    title: '', 
                    content: '', 
                    isSubmitting: false,
                    // People selector state
                    searchQuery: '',
                    selectedPeople: [],
                    availablePeople: [],
                    showDropdown: false,
                    filteredPeople: [],
                    
                    async init() {
                      // Fetch workspace members
                      try {
                        const response = await fetch(`/api/w/${workspaceId}/members`);
                        if (response.ok) {
                          this.availablePeople = await response.json();
                          this.filteredPeople = this.availablePeople;
                        }
                      } catch (error) {
                        console.error('Failed to fetch members:', error);
                      }
                    },
                    
                    filterPeople() {
                      if (this.searchQuery.trim() === '') {
                        this.filteredPeople = this.availablePeople.filter(person => 
                          !this.selectedPeople.find(selected => selected.id === person.id)
                        );
                      } else {
                        this.filteredPeople = this.availablePeople.filter(person => 
                          person.name.toLowerCase().includes(this.searchQuery.toLowerCase()) &&
                          !this.selectedPeople.find(selected => selected.id === person.id)
                        );
                      }
                      this.showDropdown = this.filteredPeople.length > 0;
                    },
                    
                    selectPerson(person) {
                      this.selectedPeople.push(person);
                      this.searchQuery = '';
                      this.showDropdown = false;
                      this.filterPeople();
                    },
                    
                    removePerson(personId) {
                      this.selectedPeople = this.selectedPeople.filter(person => person.id !== personId);
                      this.filterPeople();
                    },
                    
                    focusSearch() {
                      this.filterPeople();
                      this.showDropdown = this.filteredPeople.length > 0;
                    }
                  }"
                  x-on:submit.prevent="if (title.trim() && content.trim() && !isSubmitting) { isSubmitting = true; $el.submit(); }">
              
              <!-- Hidden inputs for selected people -->
              <template x-for="person in selectedPeople" :key="person.id">
                <input type="hidden" name="selectedMembers" :value="person.id">
              </template>
              <div class="border-b border-gray-900/10 pb-12 mt-8">
                <div class="mt-2 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
                  <div class="sm:col-span-6">
                      <!-- <label for="title" class="block text-sm font-medium leading-6 text-gray-900">Thread title</label> -->
                    <div class="">
                      <input type="text" name="title" id="title"
                             placeholder="Thread title"
                             x-model="title"
                             class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-cyan-600 sm:text-sm sm:leading-6 ">
                    </div>
                  </div>

                  <!-- People Selection Field -->
                  <div class="sm:col-span-6">
                    <label for="people-search" class="block text-sm font-medium leading-6 text-gray-900 mb-2">Add people to this thread</label>
                    
                    <!-- Selected people display -->
                    <div x-show="selectedPeople.length > 0" class="mb-3">
                      <div class="flex flex-wrap gap-2">
                        <template x-for="person in selectedPeople" :key="person.id">
                          <div class="inline-flex items-center gap-1 bg-cyan-100 text-cyan-800 text-xs font-medium px-2.5 py-1 rounded-full">
                            <img :src="person.avatar" :alt="person.name" class="w-4 h-4 rounded-full">
                            <span x-text="person.name"></span>
                            <button type="button" 
                                    @click="removePerson(person.id)"
                                    class="ml-1 text-cyan-600 hover:text-cyan-800">
                              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                              </svg>
                            </button>
                          </div>
                        </template>
                      </div>
                    </div>
                    
                    <!-- Search input with dropdown -->
                    <div class="relative">
                      <input type="text" 
                             id="people-search"
                             placeholder="Search people to add..."
                             x-model="searchQuery"
                             @input="filterPeople()"
                             @focus="focusSearch()"
                             @blur="setTimeout(() => showDropdown = false, 200)"
                             class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-cyan-600 sm:text-sm sm:leading-6">
                      
                      <!-- Dropdown -->
                      <div x-show="showDropdown && filteredPeople.length > 0" 
                           x-transition:enter="transition ease-out duration-100"
                           x-transition:enter-start="transform opacity-0 scale-95"
                           x-transition:enter-end="transform opacity-100 scale-100"
                           x-transition:leave="transition ease-in duration-75"
                           x-transition:leave-start="transform opacity-100 scale-100"
                           x-transition:leave-end="transform opacity-0 scale-95"
                           class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm">
                        <template x-for="person in filteredPeople" :key="person.id">
                          <div @click="selectPerson(person)" 
                               class="cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-cyan-50">
                            <div class="flex items-center">
                              <img :src="person.avatar" :alt="person.name" class="h-6 w-6 rounded-full flex-shrink-0">
                              <div class="ml-3">
                                <span class="font-medium block truncate" x-text="person.name"></span>
                                <span class="text-gray-500 text-xs" x-text="person.email"></span>
                              </div>
                            </div>
                          </div>
                        </template>
                      </div>
                    </div>
                  </div>

                  

                  <div class="col-span-full">
                    <!-- <label for="about" class="block text-sm font-medium leading-6 text-gray-900">Post</label> -->
                    <div class="">
                      <input id="post" type="hidden" name="content" x-model="content">
                      <trix-editor input="post" x-on:trix-change="content = $event.target.value" class="trix-editor"></trix-editor>
                    </div>
                  </div>

                  
      
                </div>
              </div>

              <div class="mt-6 flex items-center justify-end gap-x-6">
                <button type="button" class="text-sm font-semibold leading-6 text-gray-900">Cancel</button>
                <button type="submit" 
                        x-bind:disabled="!title.trim() || !content.trim() || isSubmitting"
                        x-bind:class="{'opacity-50 cursor-not-allowed': !title.trim() || !content.trim() || isSubmitting, 'hover:bg-cyan-700': title.trim() && content.trim() && !isSubmitting}"
                        class="rounded-md bg-cyan-600 px-3 py-2 text-sm font-semibold text-white shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-cyan-800">
                  <span x-text="isSubmitting ? 'Posting...' : 'Post'"></span>
                </button>
              </div>
              
            </form>
            
          </div>
        </main>
      </div>
      
      
      <script th:inline="javascript">
        /*<![CDATA[*/
        var workspaceId = /*[[${workspace.id}]]*/ 'default-url';

        

        /*]]>*/
      
      
      </script>
      
      <div th:replace="~{fragments/javascript}"></div>
      

      
    </body>
</html>